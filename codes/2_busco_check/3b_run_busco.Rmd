---
title: "Run BUSCO Pipeline on Individual Reference Sequences and Mapped Reads"
---

```{r check-busco-setup-b, include=FALSE}
f_write_log(fn_log=fn_log, msg=c("", "-------- INDIVIDUAL ASSEMBLY -------"))

# list of reference sequences
dir_refseq <- paste0(getwd(), "/refseq/")
ls_refseq <- list.dirs(dir_refseq, recursive=F, full.names=F)

# output directories
dir_readmap <- paste0(getwd(), "/busco_check/readmap/")

# create output directory
dir_busco <- paste0(getwd(), "/busco_check/busco_individual/")
if (!dir.exists(dir_busco)) {
  dir.create(dir_busco, recursive = T)
}

# set thread for BUSCO
thread_busco <- ifelse(params$thread < 50, params$thread, 50)
```

## Run BUSCO on mapped reads
```{r check-busco-read-b}
f_write_log(fn_log=fn_log, msg=c("", "------------ Mapped Reads ----------"))

dir_busco_read <- paste0(dir_busco, "short_reads/")
if (!dir.exists(dir_busco_read)) {
    dir.create(dir_busco_read, recursive=T)
}

# create doSNOW cluster
nwcl <- makeCluster(floor(params$thread/thread_busco))
doSNOW::registerDoSNOW(nwcl)

# iterate over mapped reads
foreach (prefix = ls_prefix) %dopar% {
    # initiate variable
    is_busco_run <- TRUE

    # extract sequence
    file_read <- paste0(dir_readmap, read, "/", read, ".fa")
    
    # check if BUSCO run exists
    file_busco_log <- paste0(dir_busco_read, read, "/logs/busco.log")
    if (file.exists(file_busco_log) && !params$redo) {
        finish_msg <- system(paste("grep 'BUSCO analysis done'", file_busco_log), intern=T)
        if (length(finish_msg) != 0) {
            log4r::info(fn_logger, paste0("File found: BUSCO run for ", read, ". Skipped."))
            is_busco_run <- FALSE
        }
    }

    # run BUSCO
    if (is_busco_run) {
        f_run_busco(file_read, dir_lineage, read, dir_busco_read, params$busco_mode, thread_busco, params$exe_busco)
        log4r::info(fn_logger, paste0("File created: BUSCO run for ", read, "."))
    }

    return(NULL)
}

stopCluster(nwcl)
```

## Extract common BUSCOs between reference sequences and mapped reads
```{r check-busco-common-b}
# list BUSCO directories for mapped reads
ls_prefix <- list.dirs(dir_busco_read, full.names=F, recursive=F)

# iterate over mapped reads
for (prefix in ls_prefix) {
  # directory for BUSCO alignments
  dir_buscos <- paste0(dir_busco_read, ref, "/run_", params$busco_lineage, "/busco_sequences/single_copy_busco_sequences/")
  
  # remove file extension .fna
  busco_ids <- list.files(dir_buscos, pattern = "*.fna$", full.names = F, recursive = F)
  busco_ids <- sapply(busco_ids, function(x) { gsub(".fna", "", x) })
  
  # extract shared BUSCOs between reference sequences
  if (length(shared_busco) == 0) {
    shared_busco <- busco_ids
  } else {
    shared_busco <- intersect(shared_busco, busco_ids)
  }
}

# check if shared BUSCOs found
if (length(shared_busco) == 0) {
    log4r::error(fn_logger, paste0("Error: no BUSCO shared between sequences. Exited."))
    knitr::knit_exit()
} else {
    f_write_log(fn_log=fn_log, msg=c("", paste0("Number of complete single-copy BUSCOs: ", length(shared_busco), ".")))
}
```

## Convert individual BUSCO alignments into MSA
```{r check-busco-msa-b}
dir_busco_tree <- paste0(dir_busco, "trees/")
if (!dir.exists(dir_busco_tree)) {
    dir.create(dir_busco_tree, recursive=T)
}

# create doSNOW cluster
nwcl <- makeCluster(params$thread)
doSNOW::registerDoSNOW(nwcl)

# iterate over shared BUSCOs
foreach (busco = shared_busco) %dopar% {
    dir_output <- paste0(dir_busco_tree, busco, "/")
    if (!dir.exists(dir_output)) {
        dir.create(dir_output, recursive=T)
    }

    # output MSA file
    fn_out <- paste0(dir_output, busco, ".fa")
    fn_out_aligned <- paste0(dir_output, busco, "_aligned.fa")
    if (all(file.exists(fn_out, fn_out_aligned)) && !params$redo) {
        # check if file is not empty
        if (file.size(fn_out_aligned) != 0L) {
            return(NULL)
        }
    }

    # extract BUSCO alignment from reference sequences
    ls_busco_ref <- list.dirs(dir_busco_ref, recursive=F, full.names=F)
    for (ref in ls_busco_ref) {
        file_busco_ref <- paste0(dir_busco_ref, ref, "/run_", params$busco_lineage, "/busco_sequences/single_copy_busco_sequences/", busco, ".fna")
        if (!file.exists(file_busco_ref)) {
            next
        }

        f_fasta2msa(file_busco_ref, ref, fn_out)
    }

    # extract BUSCO alignment from short reads
    ls_busco_reads <- list.dirs(dir_busco_read, recursive=F, full.names=F)
    for (read in ls_busco_reads) {
        file_busco_read <- paste0(dir_busco_read, read, "/run_", params$busco_lineage, "/busco_sequences/single_copy_busco_sequences/", busco, ".fna")
        if (!file.exists(file_busco_read)) {
            next
        }

        f_fasta2msa(file_busco_read, read, fn_out)
    }

    # align using MAFFT FFT-NS-2
    f_mafft(fn_out, fn_out_aligned, "--retree 2", params$exe_mafft)
}

stopCluster(nwcl)
```

## Generate BUSCO trees
```{r check-busco-tree-b}
f_write_log(fn_log=fn_log, msg=c("", "------------ BUSCO Trees -----------"))
              
# create doSNOW cluster
nwcl <- makeCluster(params$thread)
doSNOW::registerDoSNOW(nwcl)

# iterate over shared BUSCOs
foreach (busco = shared_busco) %dopar% {
    dir_output <- paste0(dir_busco_tree, busco, "/")

    # output IQ-Tree2 files
    fn_fasta <- paste0(dir_output, busco, "_aligned.fa")
    fn_treefile <- paste0(dir_output, busco, "_aligned.fa.treefile")
    if (!file.exists(fn_treefile) || params$redo) {
        # run IQ-Tree2
        f_iqtree2(fn_fasta, params$exe_iqtree2)
    }

    # change the ID into species name
    fn_treefile_species <- paste0(dir_output, busco, "_aligned.fa.treefile.species")
    if (!file.exists(fn_treefile_species) || params$redo) {
        tre <- readLines(fn_treefile)
        for (id in names(ls_species_name)) {
            tre <- gsub(id, ls_species_name[id], tre)
        }
        writeLines(tre, con=fn_treefile_species)
    }
}

stopCluster(nwcl)
```