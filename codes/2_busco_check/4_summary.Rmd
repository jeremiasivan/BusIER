---
title: "Summarise BUSCO Trees"
---

```{r check-summary-setup, include=FALSE}
f_write_log(fn_log=fn_log,
            msg=c("", "####################################",
                      "####           Summary          ####",
                      "####################################"))

# output directory
dir_check_summary <- paste0(dir_busco, "summary/")
dir_check_summary_noref <- paste0(dir_check_summary, "noref/")
if (!dir.exists(dir_check_summary_noref)){
    dir.create(dir_check_summary_noref, recursive=T)
}

# output files
fn_ref_summary <- paste0(dir_check_summary, params$prefix, ".ref.sumtable")
fn_read_summary <- paste0(dir_check_summary, params$prefix, ".read.sumtable")

fn_dist_tiff <- paste0(dir_check_summary, params$prefix, ".dist.tiff")
```

## Check reference bias on BUSCO trees
```{r check-summary-tree}
# create doSNOW cluster
nwcl <- makeCluster(params$thread)
doSNOW::registerDoSNOW(nwcl)

ls_output <- foreach (busco = shared_busco, .combine='c') %dopar% {
    # initiate variable
    ref_out <- list(busco=busco)
    read_out <- list(busco=busco)

    # check if treefile exists
    fn_tree <- paste0(dir_busco_tree, busco, "/", busco, "_aligned.fa.treefile")
    if (!file.exists(fn_tree)){
        log4r::info(fn_logger, paste0("File not found: BUSCO tree for ", busco, ". Skipped."))
        return(NULL)
    }

    # read tree
    tre <- ape::read.tree(fn_tree)
    ls_tips <- tre$tip.label

    # extract reference topology
    topology_ref <- ape::keep.tip(tre, ls_refseq)
    topology_ref$edge.length <- NULL

    # iterate over reference sequences
    for (ref in ls_refseq) {
        # extract list of taxa with specific reference
        ls_taxa <- ls_tips[stringr::str_detect(ls_tips, ref)]
        if (length(ls_taxa) <= 1) {
            ref_out[[ls_species_name[ref]]] <- "INVALID"
            next
        } else if (length(ls_shortreads)+1 > length(ls_taxa)) {
            ref_out[[ls_species_name[ref]]] <- "INCOMPLETE"
            next
        }

        # check if reference-based clade is monophyletic
        is_monophyletic <- ape::is.monophyletic(tre, tips = ls_taxa)
        if (is_monophyletic) {
            ref_out[[ls_species_name[ref]]] <- "REFBIAS"
            next
        }

        ref_out[[ls_species_name[ref]]] <- "?"
    }

    # iterate over short reads
    for (read in ls_shortreads) {
        # extract list of taxa with specific reference
        ls_taxa <- ls_tips[stringr::str_detect(ls_tips, read)]
        if (length(ls_taxa) <= 1) {
            read_out[[ls_species_name[read]]] <- "INVALID"
            next
        } else if (length(ls_refseq) > length(ls_taxa)) {
            read_out[[ls_species_name[read]]] <- "INCOMPLETE"
            next
        }

        # check if reference-based clade is monophyletic
        is_monophyletic <- ape::is.monophyletic(tre, tips = ls_taxa)
        if (is_monophyletic) {
            read_out[[ls_species_name[read]]] <- "PERFECT"
            next
        }

        # check for topology-based reference bias
        topology_read <- ape::keep.tip(tre, ls_taxa)
        topology_read$edge.length <- NULL
        topology_read$tip.label <- gsub(".*--", "", topology_read$tip.label)

        if (ape::all.equal.phylo(topology_ref, topology_read)) {
            read_out[[ls_species_name[read]]] <- "TOPBIAS"
            next
        }

        read_out[[ls_species_name[read]]] <- "?"
    }

    return(list(ref_out=ref_out, read_out=read_out))
}

stopCluster(nwcl)

# convert list into dataframe
ls_ref_out <- ls_output[names(ls_output)=="ref_out"]
ls_read_out <- ls_output[names(ls_output)=="read_out"]

df_ref_output <- data.table::as.data.table(do.call(rbind, ls_ref_out), fill=TRUE)
data.table::fwrite(df_ref_output, file=fn_ref_summary, sep="\t", quote=F, row.names=F)

df_read_output <- data.table::as.data.table(do.call(rbind, ls_read_out), fill=TRUE)
data.table::fwrite(df_read_output, file=fn_read_summary, sep="\t", quote=F, row.names=F)

log4r::info(fn_logger, "File created: summary for BUSCO trees.")
```

## Calculate MNTD on BUSCO trees
```{r check-summary-mntd}
# run MNTD with reference sequence
prefix <- paste0(dir_check_summary, params$prefix)
f_run_mntd(shared_busco, ls_refseq, TRUE, dir_busco_tree, ls_species_name, prefix, params$thread)

# run MNTD without reference sequence
prefix <- paste0(dir_check_summary_noref, params$prefix)
f_run_mntd(shared_busco, ls_refseq, FALSE, dir_busco_tree, ls_species_name, prefix, params$thread)
```

## Calculate phylogenetic distance between mapped reads and references
```{r check-summary-individual}
# extract representative species
df_reads_ref <- data.table::data.table(species=character(), reads=character(), ref=character())

df_reads_subset <- df_reads[df_reads$is_check,]
for (i in 1:nrow(df_reads_subset)) {
    species_name <- df_reads_subset$species[i]

    # extract reference ID
    ref_id <- df_refs$id[df_refs$species == species_name]

    # update data.frame
    df_reads_ref <- rbind(df_reads_ref, data.table::data.table(species=species_name, reads=df_reads_subset$id[i], ref=ref_id))
}

# create doSNOW cluster
nwcl <- makeCluster(params$thread)
doSNOW::registerDoSNOW(nwcl)

ls_output <- foreach (busco = shared_busco, .combine='c') %dopar% {
    # check if treefile exists
    fn_tree <- paste0(dir_busco_tree, busco, "/", busco, "_aligned.fa.treefile")
    if (!file.exists(fn_tree)){
        log4r::info(fn_logger, paste0("File not found: BUSCO tree for ", busco, ". Skipped."))
        return(NULL)
    }

    # read tree
    tre <- ape::read.tree(fn_tree)
    ls_tips <- tre$tip.label

    # calculate phylogenetic distance
    distance_tre <- ape::cophenetic.phylo(tre)

    # iterate over reads
    ls_dist <- c()
    for (i in 1:nrow(df_reads_ref)) {
        ls_dist <- c(ls_dist, distance_tre[rownames(distance_tre)==paste0(df_reads_ref$reads[i],"--",df_reads_ref$ref[i]),
                                           colnames(distance_tre)==df_reads_ref$ref[i]])
    }
    
    return(ls_dist)
}

stopCluster(nwcl)

# visualization
tiff(file=fn_dist_tiff, units="px", width=2880, height=1800)
ggplot(data.frame(ls_output), aes(x=ls_output, xmin=0)) + 
    geom_density() +
    ggtitle("BUSCO Phylogenetic Distance between Mapped Reads and Reference") + ylab("Density") +
    theme(plot.title = element_text(hjust=0.5, size=50),
        plot.margin = margin(1.25, 1.25, 1.25, 1.25, "cm"),
        axis.text.x = element_text(size=30),
        axis.title.x = element_blank(),
        axis.text.y = element_text(size=30),
        axis.title.y = element_text(size=40, margin=margin(t=0, r=20, b=0, l=0)),
        legend.position = "none")
dev.off()
```